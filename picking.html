<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbalife Picking System v8.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --hb-green: #7dc242; }
        .bg-hb-green { background-color: var(--hb-green); }
        .text-hb-green { color: var(--hb-green); }
        .row-complete { background-color: #d1fae5 !important; border-left: 5px solid #10b981; }
        .row-pending { background-color: #fef3c7 !important; border-left: 5px solid #f59e0b; }
        .row-error { background-color: #fee2e2 !important; border-left: 5px solid #ef4444; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; display: none; margin-top: 10px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-hb-green text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="font-bold text-lg tracking-tight">HERBALIFE NUTRITION</h1>
            <div id="status" class="text-[10px] bg-white text-green-600 px-3 py-1 rounded-full font-bold shadow-sm">CONECTADO</div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                <span class="block text-gray-400 text-[10px] uppercase font-bold">√ìrdenes</span>
                <span id="stat-total" class="text-2xl font-black">0</span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm text-center border-b-4 border-hb-green">
                <span class="block text-hb-green text-[10px] uppercase font-bold">Listas</span>
                <span id="stat-done" class="text-2xl font-black">0</span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm text-center border-b-4 border-yellow-400">
                <span class="block text-yellow-500 text-[10px] uppercase font-bold">Pendientes</span>
                <span id="stat-pend" class="text-2xl font-black">0</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                    <h2 class="text-sm font-bold mb-3 text-gray-700 uppercase">1. Datos del Grupo</h2>
                    <input type="text" id="operario" placeholder="Nombre de Operario" class="w-full p-3 border rounded-lg mb-3 text-sm focus:ring-2 focus:ring-green-400 outline-none">
                    <input type="text" id="grupo" placeholder="N√∫mero de Grupo" class="w-full p-3 border rounded-lg mb-3 text-sm focus:ring-2 focus:ring-green-400 outline-none">
                    <button onclick="document.getElementById('fileInput').click()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-black transition text-sm shadow">IMPORTAR EXCEL</button>
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx">
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border-2 border-hb-green">
                    <h2 class="text-sm font-bold mb-3 text-gray-700 uppercase">2. Escaneo de Picking</h2>
                    <input type="text" id="scanner" placeholder="Escanear Orden o SKU..." class="w-full p-4 text-lg border-2 border-gray-100 rounded-xl focus:border-hb-green outline-none font-mono">
                    
                    <button onclick="toggleCamara()" class="mt-4 w-full bg-blue-500 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-bold text-sm hover:bg-blue-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                        USAR C√ÅMARA DEL CELULAR
                    </button>
                    <div id="reader"></div>
                    <div id="feedback" class="mt-3 p-3 rounded-lg text-center font-bold text-xs hidden"></div>
                </div>

                <button onclick="exportarReporte()" class="w-full bg-hb-green text-white font-bold py-4 rounded-xl shadow-lg hover:brightness-95 transition">DESCARGAR SUSTENTO FINAL</button>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-md min-h-[500px]">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-md font-bold uppercase text-gray-600">Orden Actual: <span id="display-order" class="text-hb-green">-</span></h2>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-gray-400 uppercase text-[10px] tracking-wider border-b">
                                    <th class="pb-3">Producto / SKU</th>
                                    <th class="pb-3">Lote</th>
                                    <th class="pb-3 text-center">Cant.</th>
                                    <th class="pb-3 text-center">Le√≠do</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-gray-50">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-10 text-center text-gray-400 text-[10px] uppercase tracking-widest">
            Autor del proyecto: <span class="font-bold">Carlos Aviles</span>
        </footer>
    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE (REEMPLAZAR CON TUS DATOS) ---
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            databaseURL: "https://TU_PROYECTO.firebaseio.com",
            projectId: "TU_PROYECTO",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentOrder = null;
        let localData = {};
        const html5QrCode = new Html5Qrcode("reader");

        // --- IMPORTAR EXCEL ---
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                let upload = {};
                json.forEach((row) => {
                    const ord = String(row.ordernumber || '').trim();
                    if (!ord) return;
                    if (!upload[ord]) upload[ord] = [];
                    upload[ord].push({
                        sku: String(row.SKU || '').trim().toUpperCase(),
                        desc: row.DescripcionLocal || 'SIN DESCRIPCI√ìN',
                        cant: parseInt(row.Cant) || 0,
                        lote: row.Lote || '-',
                        scanned: 0
                    });
                });

                db.ref('picking_live').set(upload)
                    .then(() => alert("‚úÖ Base de datos cargada correctamente."));
            };
            reader.readAsArrayBuffer(file);
        });

        // --- SINCRONIZACI√ìN EN TIEMPO REAL ---
        db.ref('picking_live').on('value', (snap) => {
            localData = snap.val() || {};
            renderStats();
            if (currentOrder) renderOrden(currentOrder);
        });

        // --- PROCESAR ESCANEO ---
        const scannerInput = document.getElementById('scanner');
        scannerInput.addEventListener('input', (e) => {
            const val = e.target.value.trim().toUpperCase();
            if (!val) return;

            // Detectar si es Orden (4L / E4)
            if (val.startsWith('4L') || val.startsWith('E4')) {
                if (localData[val]) {
                    currentOrder = val;
                    showFeedback(üì¶ Orden ${val} seleccionada, 'green');
                    renderOrden(val);
                } else {
                    showFeedback("‚ùå La orden no existe en la base", "red");
                }
                scannerInput.value = '';
                return;
            }

            // Detectar si es SKU
            if (currentOrder) {
                validarSKU(val);
                scannerInput.value = '';
            } else {
                showFeedback("‚ö†Ô∏è Escanee una ORDEN primero", "red");
                scannerInput.value = '';
            }
        });

        function validarSKU(sku) {
            let lines = localData[currentOrder];
            let found = false;

            // L√≥gica de Cascada (REGLA CR√çTICA)
            for (let line of lines) {
                if (line.sku === sku && line.scanned < line.cant) {
                    line.scanned++;
                    db.ref(picking_live/${currentOrder}).set(lines);
                    showFeedback(‚úÖ SKU ${sku} OK, "green");
                    found = true;
                    break;
                }
            }

            if (!found) showFeedback(üö´ SKU ${sku} NO PERTENECE O EST√Å LLENO, "red");
        }

        // --- RENDERIZADO UI ---
        function renderOrden(id) {
            const tbody = document.getElementById('table-body');
            document.getElementById('display-order').innerText = id;
            tbody.innerHTML = '';

            localData[id].forEach(l => {
                const isComplete = l.scanned >= l.cant;
                const tr = document.createElement('tr');
                if (isComplete) tr.className = 'row-complete';
                else if (l.scanned > 0) tr.className = 'row-pending';

                tr.innerHTML = `
                    <td class="py-4 px-2 font-bold">${l.sku}<br><span class="text-[9px] font-normal text-gray-400">${l.desc}</span></td>
                    <td class="py-4 px-2 text-gray-400 font-mono text-xs">${l.lote}</td>
                    <td class="py-4 px-2 text-center font-black">${l.cant}</td>
                    <td class="py-4 px-2 text-center text-lg font-black">${l.scanned}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderStats() {
            const keys = Object.keys(localData);
            let done = 0;
            keys.forEach(k => {
                if (localData[k].every(l => l.scanned >= l.cant)) done++;
            });
            document.getElementById('stat-total').innerText = keys.length;
            document.getElementById('stat-done').innerText = done;
            document.getElementById('stat-pend').innerText = keys.length - done;
        }

        function showFeedback(msg, color) {
            const f = document.getElementById('feedback');
            f.innerText = msg;
            f.className = mt-4 p-3 rounded-lg text-center font-bold text-xs block ${color === 'green' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'};
            setTimeout(() => f.classList.add('hidden'), 2000);
        }

        function toggleCamara() {
            const r = document.getElementById('reader');
            if (r.style.display === 'block') {
                html5QrCode.stop();
                r.style.display = 'none';
            } else {
                r.style.display = 'block';
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (text) => { 
                    const scanVal = text.trim().toUpperCase();
                    if(scanVal.startsWith('4L') || scanVal.startsWith('E4')){
                         currentOrder = scanVal;
                         renderOrden(scanVal);
                    } else if(currentOrder) {
                         validarSKU(scanVal);
                    }
                });
            }
        }

        function exportarReporte() {
            const op = document.getElementById('operario').value || 'S/N';
            const gr = document.getElementById('grupo').value || '00';
            const fecha = new Date().toLocaleDateString();
            
            let dataExport = [];
            Object.keys(localData).forEach(orderId => {
                localData[orderId].forEach(l => {
                    dataExport.push({
                        Fecha: fecha, Grupo: gr, Responsable: op,
                        Orden: orderId, SKU: l.sku, Requerido: l.cant, 
                        Escaneado: l.scanned, Estado: l.scanned >= l.cant ? 'OK' : 'PENDIENTE'
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sustento");
            XLSX.writeFile(wb, Picking_Herbalife_G${gr}_${fecha}.xlsx);
        }
    </script>
</body>
</html>